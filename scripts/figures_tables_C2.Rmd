---
title: "Sunapee Temp and Landsat C2_lst Figures and Tables"
author: "B. Steele"
date: "24Sept2021"
output: html_document
---

This script walks through the analyses and figures presented in the Herrick, et al, MS using all historical LS data for Lake Sunapee. 



```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

source('R_library.R')

dir = '~/GitHub/ids-ne-lakes/'
datadir = '~/GitHub/ids-ne-lakes/data/'
figdir = '~/GitHub/ids-ne-lakes/figures/'

```


#Read in all data

```{r}
#load in all high-frequency insitu data for historical data analysis
insitu <- read.csv(paste0(datadir, 'insitu_temp_data_v2021-05-17.csv')) %>% 
  filter(!is.na(lat_dd)) %>% 
  mutate(datetime = as.POSIXct(datetime, tz='Etc/GMT+5'))

#read in all skin temp data for whole lake
C2_lst_all <- read_csv(paste0(datadir, 'colab-output/C2/sunapee_1980_2020_C2_stats.csv'),
                             col_types = c('')) %>% 
  mutate(date =as.Date(substrRight(`system:index`, 8), '%Y%m%d'),
         month = as.numeric(format(date, '%m')),
         year = as.factor(format(date, '%Y')),
         doy = as.numeric(format(date, '%j')),
         LSmission = case_when(grepl('LT04', `system:index`) ~ 'LS 4',
                               grepl('LT05', `system:index`) ~ 'LS 5',
                               grepl('LE07', `system:index`) ~ 'LS 7',
                               grepl('LC08', `system:index`) ~ 'LS 8')) %>% 
  rowid_to_column()

C2_lst_all %>% 
  group_by(LSmission) %>% 
  summarize(count = length(LSmission))

# REPLACE WITH REAL FILE LATER
C2_lst_paired <- read_csv(paste0(datadir, 'colab-output/C2/temporary_sunapee_stats_paired_C2.csv'),
                             col_types = c('')) 

```


## Summary Data Tables for insitu database

```{r}

#number of observations for total DB
insitu %>% 
  summarize(nobs = length(datetime),
            ndays = length(unique(format(datetime, '%Y-%m-%d'))),
            year_start = min(as.numeric(format(datetime, '%Y'))),
            year_end = max(as.numeric(format(datetime, '%Y'))), 
            min_month = min(as.numeric(format(datetime, '%m'))),
            max_month = max(as.numeric(format(datetime, '%m'))),
            nsites = length(unique(location)))

#number of observations between time of 9 and 11
insitu %>% 
  mutate(hour = as.numeric(format(datetime, '%H'))) %>% 
  filter(hour >= 9 & hour < 11) %>% 
  summarize(nobs = length(datetime),
            ndays = length(unique(format(datetime, '%Y-%m-%d'))),
            year_start = min(as.numeric(format(datetime, '%Y'))),
            year_end = max(as.numeric(format(datetime, '%Y'))), 
            min_month = min(as.numeric(format(datetime, '%m'))),
            max_month = max(as.numeric(format(datetime, '%m'))),
            nsites = length(unique(location)))


#number of sites
length(unique(insitu$location))
unique(insitu$location)

#document max spread and IQR for C2_lst filtering
range_per_date <- insitu %>% 
  mutate(hour = as.numeric(format(datetime, '%H')),
         date = as.Date(datetime)) %>% 
  filter(hour >= 9 & hour < 11) %>% 
  group_by(date) %>% 
  summarize(temp_range = max(temp_degC) - min(temp_degC),
            IQR = IQR(temp_degC, na.rm = T),
            n_locs = length(unique(location)))
max_spread <- max(range_per_date$temp_range, na.rm = T)
max_IQR <- max(range_per_date$IQR, na.rm = T)

range_summary <- range_per_date %>% 
  mutate(month = as.numeric(format(date, '%m'))) %>% 
  group_by(month) %>% 
  summarise(min_range = min(temp_range, na.rm = T),
            max_range = max(temp_range, na.rm = T),
            min_IQR = min(IQR, na.rm = T),
            max_IQR = max(IQR, na.rm = T))

```

## Summary of location/depth/measurement

```{r}
insitu %>% 
  mutate(year = format(datetime, '%Y'),
         month = as.numeric(format(datetime, '%m'))) %>% 
  group_by(year, location) %>% 
  summarise(min_depth_m = min(depth_m),
            max_depth_m = max(depth_m),
            min_month = min(month),
            max_month = max(month)) %>% 
  pivot_longer(!c(year, location), names_to = 'variable', values_to = 'value') %>% 
  pivot_wider(id_cols = c(year, variable, value),
              names_from = c(location, variable)) %>% 
  write.csv(., file.path(datadir, 'insitu_data_extent_summary.csv'), row.names = F)

```
 
## QAQC flags for freezing temp images; non unimodal; max spread or IQR <110% observed; Summary of C2_lst data according to QAQC flags

```{r}
C2_lst_all_val <- C2_lst_all %>% 
  mutate(freeze_QAQC = case_when(temp_min < 0 ~ 'F', #pass/fail for freezing temps
                                 TRUE ~ 'P')) %>% 
  # left_join(., modal_analysis) %>% #join with modal analysis
  # mutate(unimodal_QAQC = case_when(unimodal == 'unimodal' ~ 'P',
  #                                  TRUE ~ 'F')) %>%  # pass/fail for unimodality
  mutate(temp_spread = round(temp_max, digits = 1) - round(temp_min, digits = 1)) %>% #calc temp spread; pass/fail for temp spread
  mutate(spread_QAQC = case_when(temp_spread < max_spread*1.1 ~ 'P',
                                 TRUE ~ 'F')) %>% 
  mutate(IQR = round(temp_p75, digits = 1) - round(temp_p25, digits = 1))  %>%  #calc IQR; pass/fail for temp IQR
  mutate(IQR_QAQC = case_when(IQR < max_IQR*1.1 ~ 'P',
                              TRUE ~ 'F'))

C2_lst_filt_maxrange <- C2_lst_all_val %>% 
  filter(freeze_QAQC == 'P' & 
           # unimodal_QAQC == 'P' & 
           spread_QAQC == 'P')

C2_lst_filt_maxrange %>% 
  group_by(LSmission) %>% 
  summarize(count = length(LSmission))

C2_lst_filt_maxIQR <- C2_lst_all_val %>% 
  filter(freeze_QAQC == 'P' & 
           # unimodal_QAQC == 'P' & 
           IQR_QAQC == 'P')

C2_lst_filt_maxIQR %>% 
  group_by(LSmission) %>% 
  summarize(count = length(LSmission))

# ggplot(C2_lst_all_val, aes(x = pct_lake, y = (temp_max-temp_min))) +
#   geom_point(aes(color = month)) +
#   labs(y = 'temp_spread')+
#   geom_abline(intercept = 1.1 * max_spread, slope = 0, lty = 2) +
#   final_theme
# ggsave(file.path(figdir, 'C2 tempspread by pct lake by month summary.png'))
# 
# ggplot(C2_lst_all_val, aes(x = pct_lake, y = (temp_p75-temp_p25))) +
#   geom_point(aes(color = month)) +
#   labs(y = 'temp_IQR')+
#     geom_abline(intercept = 1.1 * max_IQR, slope = 0, lty = 2) +
# final_theme
# ggsave(file.path(figdir, 'C2 temp IQR by pct lake by month summary.png'))
# 
# ggplot(C2_lst_filt_maxrange, aes(x = pct_lake, y = temp_spread)) +
#   geom_point(aes(color = month)) +
#   final_theme
# ggsave(file.path(figdir, 'C2 filtered tempspread by pct lake by month summary.png'))
# 
# ggplot(C2_lst_filt_maxIQR, aes(x = pct_lake, y = IQR)) +
#   geom_point(aes(color = month)) +
#   final_theme
# ggsave(file.path(figdir, 'C2 filtered temp IQR by pct lake by month summary.png'))

```
## Figures of 
## Summary Data Tables for insitu-skin temp match
waiting on match details; percent of lake

```{r}
# #inner join with unimodal data and 25% of lake
# match_details_range <- match_details %>% 
#   mutate(date = as.Date(date)) %>% 
#   inner_join(., C2_lst_all_val) %>% 
#   filter(freeze_QAQC == 'P' & unimodal_QAQC == 'P' & spread_QAQC == 'P') %>% 
#   filter(perc_lake > 25)
# 
# match_details_IQR <- match_details %>% 
#   mutate(date = as.Date(date)) %>% 
#   inner_join(., C2_lst_all_val) %>% 
#   filter(freeze_QAQC == 'P' & unimodal_QAQC == 'P' & IQR_QAQC == 'P') %>% 
#   filter(perc_lake > 25)
# 
# #number of observations where there is a match with LS data
# match_details_range %>% 
#   summarize(nobs = length(datetime),
#             ndays = length(unique(format(datetime, '%Y-%m-%d'))),
#             year_start = min(as.numeric(format(datetime, '%Y'))),
#             year_end = max(as.numeric(format(datetime, '%Y'))))
# 
# length(unique(match_details_range$location))
# 
# match_details_IQR %>% 
#   summarize(nobs = length(datetime),
#             ndays = length(unique(format(datetime, '%Y-%m-%d'))),
#             year_start = min(as.numeric(format(datetime, '%Y'))),
#             year_end = max(as.numeric(format(datetime, '%Y'))))
# 
# length(unique(match_details_IQR$location))

```

# Initial validation - using all data, by range and IQR

## pair qaqc skin temp with insitu as validation data
```{r}
C2_validation_range <- C2_lst_filt_maxrange %>%
  select(date, LSmission) %>% 
  inner_join(., C2_lst_paired)
C2_validation_IQR <- C2_lst_filt_maxIQR%>%
  select(date, LSmission) %>% 
  inner_join(., C2_lst_paired)

```

## predicted v observed by max range
```{r}
val_med_ls <-deming::deming(C2_validation_range$surface_temp_median ~ C2_validation_range$temp_med)
val_med_ls

cor(C2_validation_range$surface_temp_median, C2_validation_range$temp_med)

ggplot(C2_validation_range, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_ls$coefficients[1], slope = val_med_ls$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_ls$ci[1,1], slope = val_med_ls$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_ls$ci[1,2], slope = val_med_ls$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(5,27),
                  ylim = c(5,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'C2_deming_range_v07Oct2021.jpg'), height = 5, width = 5, units = 'in')

C2_validation_range$pred_temp_range = val_med_ls$coefficients[1] + val_med_ls$coefficients[2]*C2_validation_range$temp_med

C2_lst_insitu_dem_forresid = mcreg(x = C2_validation_range$temp_med, y = C2_validation_range$surface_temp_median, method.reg = 'Deming')
C2_validation_range$opt_resid_range = MCResult.getResiduals(C2_lst_insitu_dem_forresid)$optimized

#plot to make sure prediction is correct
ggplot(C2_validation_range, aes(x = temp_med, y = pred_temp_range))+
  geom_point(color = 'blue') +
  geom_point(aes(x = temp_med, y = surface_temp_median))
```

### apply calibration of temp to LS-derived data
```{r}
C2_validation_range <- C2_validation_range %>% 
  mutate(calib_range = (surface_temp_median-val_med_ls$coefficients[1])/val_med_ls$coefficients[2]) %>% 
  select(date, LSmission, temp_med, pred_temp_range, opt_resid_range, calib_range)

#apply to all QAQC IQR dataset
C2_calibration_range <- C2_lst_filt_maxrange %>% 
  mutate(calib_range = (temp_median-val_med_ls$coefficients[1])/val_med_ls$coefficients[2])%>% 
  select(date, LSmission, calib_range)

C2_lst_all_val <- C2_lst_all_val %>% 
  full_join(., C2_validation_range)

ggplot(C2_lst_all_val, aes(x = temp_med, y = temp_median)) +
  geom_point() +
  geom_point(aes(x = temp_med, y = calib_range), color = 'red')+
  geom_abline(intercept = val_med_ls$coefficients[1], slope = val_med_ls$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_ls$ci[1,1], slope = val_med_ls$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_ls$ci[1,2], slope = val_med_ls$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme

C2_lst_all_val <- full_join(C2_lst_all_val, C2_calibration_range)

```
  

## predicted v observed by IQR
```{r}
val_med_IQR_dem <-deming::deming(C2_validation_IQR$surface_temp_median ~ C2_validation_IQR$temp_med)
val_med_IQR_dem

cor(C2_validation_IQR$surface_temp_median, C2_validation_IQR$temp_med)

ggplot(C2_validation_IQR, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_IQR_dem$coefficients[1], slope = val_med_IQR_dem$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_IQR_dem$ci[1,1], slope = val_med_IQR_dem$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_IQR_dem$ci[1,2], slope = val_med_IQR_dem$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'C2_deming_reg_median_IQR_v07Oct2021.jpg'), height = 5, width = 5, units = 'in')

C2_validation_IQR$pred_temp_IQR = val_med_IQR_dem$coefficients[1] + val_med_IQR_dem$coefficients[2]*C2_validation_IQR$temp_med

C2_lst_insitu_IQR_dem_forresid = mcreg(x = C2_validation_IQR$temp_med, y = C2_validation_IQR$surface_temp_median, method.reg = 'Deming')
C2_validation_IQR$opt_resid_IQR = MCResult.getResiduals(C2_lst_insitu_IQR_dem_forresid)$optimized

#plot to make sure prediction is correct
ggplot(C2_validation_IQR, aes(x = temp_med, y = pred_temp_IQR))+
  geom_point(color = 'blue') +
  geom_point(aes(x = temp_med, y = surface_temp_median))
```


### apply calibration of temp to LS-derived data - IQR

```{r}

#apply to the validation set
C2_validation_IQR<- C2_validation_IQR %>% 
  mutate(calib_IQR = (surface_temp_median-val_med_IQR_dem$coefficients[1])/val_med_IQR_dem$coefficients[2])%>% 
  select(date, LSmission, pred_temp_IQR, opt_resid_IQR, calib_IQR)

#apply to all QAQC IQR dataset
C2_calibration_IQR <- C2_lst_filt_maxIQR %>% 
  mutate(calib_IQR = (temp_median-val_med_IQR_dem$coefficients[1])/val_med_IQR_dem$coefficients[2])%>% 
  select(date, LSmission, calib_IQR)

C2_lst_all_val <- C2_lst_all_val %>% 
  full_join(., C2_validation_IQR)

#plot to make sure calibration is correct
ggplot(C2_lst_all_val, aes(x = temp_med, y = temp_median)) +
  geom_point() +
  geom_point(aes(x = temp_med, y = calib_IQR), color = 'red')+
  geom_abline(intercept = val_med_IQR_dem$coefficients[1], slope = val_med_IQR_dem$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_IQR_dem$ci[1,1], slope = val_med_IQR_dem$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_IQR_dem$ci[1,2], slope = val_med_IQR_dem$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme

C2_lst_all_val <- full_join(C2_lst_all_val, C2_calibration_IQR)


```

Export C2 data with validation and calibration data
```{r}
write.csv(C2_lst_all_val, file.path(datadir, paste0('LS_C2_QAQC_calval_v', Sys.Date(), '.csv')), row.names = F)
```


# MSE and bias by month using opt_resid
```{r}

# calculate mse with optomized residuals
#re-orient data for residual analysis
C2_lst_resid <- C2_lst_all_val %>% 
  select(month, LSmission, opt_resid_IQR, opt_resid_range) %>% 
  rename(IQR = opt_resid_IQR,
         range = opt_resid_range) %>% 
  pivot_longer(cols = c('IQR', 'range'),
               names_to = 'filter',
               values_to = 'opt_resid')  %>% 
  filter(!is.na(opt_resid)) %>% 
  mutate(month = as.character(month))

#all data
all_error <- C2_lst_resid %>% 
  group_by(filter) %>% 
  summarise(mse = round(sum((opt_resid^2))/n(), digits = 2),
            rmse = round(sqrt(mse), digits = 2),
            bias = round(sum(opt_resid)/n(), digits = 2),
            mae = round(sum(abs(opt_resid))/n(), digits = 2),
            n_obs = n()) %>% 
  mutate(LSmission = 'All missions',
         month = 'All months')
all_error
# %>% 
#     write.csv(., file.path(datadir, 'LSC2_deming_prediction_stats_v07Oct2021.csv'))

#all data by mission
mission_error <- C2_lst_resid %>% 
  group_by(filter, LSmission) %>% 
  summarise(mse = round(sum((opt_resid^2))/n(), digits = 2),
            rmse = round(sqrt(mse), digits = 2),
            bias = round(sum(opt_resid)/n(), digits = 2),
            mae = round(sum(abs(opt_resid))/n(), digits = 2),
            n_obs = n()) %>% 
  mutate(month = 'All months')
mission_error
# %>% 
#     write.csv(., file.path(datadir, 'LS_C2_deming_prediction_bymission_stats_v07Oct2021.csv'))


# by month
month_error <- C2_lst_resid %>% 
  group_by(filter, month) %>% 
  summarise(mse = round(sum((opt_resid^2))/n(), digits = 2),
            rmse = round(sqrt(mse), digits = 2),
            bias = round(sum(opt_resid)/n(), digits = 2),
            mae = round(sum(abs(opt_resid))/n(), digits = 2),
            n_obs = n()) %>% 
  select(filter, month, n_obs, mae, mse, rmse, bias) %>% 
  mutate(LSmission = 'All missions')
month_error
# %>% 
#   write.csv(., file.path(datadir, 'LS_C2_deming_prediction_stats_allmissions_v07Oct2021.csv'))


#by month and mission
month_mission_error <- C2_lst_resid %>% 
  group_by(filter, month, LSmission) %>% 
  summarise(mse = round(sum((opt_resid^2))/n(), digits = 2),
            rmse = round(sqrt(mse), digits = 2),
            bias = round(sum(opt_resid)/n(), digits = 2),
            mae = round(sum(abs(opt_resid))/n(), digits = 2),
            n_obs = n())  %>% 
  select(month, filter, LSmission, n_obs, mse, mae, rmse, bias) 
month_mission_error

C2_error <- full_join(all_error, month_error) %>% 
  full_join(., mission_error) %>% 
  full_join(., month_mission_error) %>%
  pivot_longer(!c(month, LSmission, filter), names_to = 'variable', values_to = 'values') %>%
  mutate(variable = factor(variable, levels = c('n_obs', 'mae','mse', 'rmse', 'bias'))) %>%
  arrange(month, variable) %>%
  pivot_wider(names_from = c(LSmission),
              values_from = values) %>% 
  select(month, filter, variable:`LS 8`) %>% 
  mutate(month = factor(month, levels = c('All months', '5', '6', '7', '8', '9', '10', '11'))) %>% 
  arrange(month)

write.csv(C2_error, file.path(datadir, 'LSC2_deming_prediction_stats_v07Oct2021.csv'))

```


# Residuals 

## plot residuals by x

```{r}
C2_lst_insitu_dem_forresid = mcreg(x = C2_validation_range$temp_med, y = C2_validation_range$surface_temp_median, method.reg = 'Deming')


ggplot(C2_validation_range, aes(sample = opt_resid_range)) +
  geom_qq() +
  geom_qq_line()

ggplot(C2_validation_range, aes (y = opt_resid_range, x = temp_med)) +
  geom_point() +
  labs(x = 'in-situ median water temp (deg C)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_x_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = temp_med, color = month)) +
  geom_point(size = 2) +
  labs(x = 'in-situ median water temp (deg C)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme +
  scale_color_colorblind()
ggsave(paste0(dir, 'figures/optresid_x_colorbymonth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')
```

## residuals by cloud cover
```{r}
ggplot(C2_validation_range, aes (y = opt_resid, x = cloud_cover)) +
  geom_point() +
  labs(x = 'cloud cover (percent)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_cloudcover_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = cloud_cover, color = month)) +
  geom_point(size = 2) +
  labs(x = 'cloud cover (percent)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme +
  scale_color_colorblind()
ggsave(paste0(dir, 'figures/optresid_cloudcover_colorbymonth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

```

## residuals by pixel count
```{r}
ggplot(C2_validation_range, aes (y = opt_resid, x = pixel_count)) +
  geom_point() +
  labs(x = 'pixel count',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_pixelcount_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = pixel_count, color = month)) +
  geom_point(size = 2) +
  labs(x = 'pixel count',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme +
  scale_color_colorblind()
ggsave(paste0(dir, 'figures/optresid_pixelcount_colorbymonth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

```

## residuals by mean sample depth
```{r}
ggplot(C2_validation_range, aes (y = opt_resid, x = depth_avg)) +
  geom_point() +
  labs(x = 'mean in-situ depth (m)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_insitudepth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = depth_avg, color = month)) +
  geom_point(size = 2) +
  labs(x = 'mean in-situ depth (m)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme +
  scale_color_colorblind()
ggsave(paste0(dir, 'figures/optresid_insitudepth_colorbymonth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

```

## residuals by month, year, doy
```{r}
ggplot(C2_validation_range, aes (y = opt_resid, x = month)) +
  geom_point() +
  labs(x = 'month',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_month_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = month, color = pixel_count)) +
  geom_point(size = 2) +
  labs(x = 'month',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_month_bypixelcount_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = month, color = cloud_cover)) +
  geom_point(size = 2) +
  labs(x = 'month',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_month_bycloudcover_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = year)) +
  geom_point() +
  labs(x = 'year',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_year_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = year, color = pixel_count)) +
  geom_point(size = 2) +
  labs(x = 'year',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_year_bypixelcount_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = year, color = cloud_cover)) +
  geom_point(size = 2) +
  labs(x = 'year',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_year_bycloudcover_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = doy)) +
  geom_point() +
  labs(x = 'doy',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_doy_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = doy, color = pixel_count)) +
  geom_point(size = 2) +
  labs(x = 'doy',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_doy_bypixelcount_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')

ggplot(C2_validation_range, aes (y = opt_resid, x = doy, color = cloud_cover)) +
  geom_point(size = 2) +
  labs(x = 'doy',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme 
ggsave(paste0(dir, 'figures/optresid_doy_bycloudcover_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')


```

## residuals by sun angle and azimuth
```{r}
ggplot(C2_validation_range, aes (y = opt_resid, x = azimuth)) +
  geom_point() +
  labs(x = 'azimuth (degrees)',
       y = 'deming optimized residuals (deg C)') +
  geom_hline(yintercept = 0, color = 'black') +
  final_theme
ggsave(paste0(dir, 'figures/optresid_azimuth_v28Jun2021.jpg'), height = 5, width = 8, units = 'in')


```

# Validation trials - play with in-situ database

## only use primary GLEON buoy data

## only use 2 years of data (buoy only)

## only use 2018 data

## only use littoral data (from KLC traps)

## only use 2 years of data (all sources)




# Validation trials - play with LS variables 

Goal here: what is important to LS variables? How does it change the regression and error calcs?


## predicted v observed 50% cutoff for lake - range
```{r}
validtion_50_range <- C2_validation_range %>% 
  filter(perc_lake > 50)
val_med_ls_50_range <- lm(validtion_50_range$surface_temp_median ~ validtion_50_range$temp_med)
summary(val_med_ls_50_range)

val_med_dem_50_range <-deming::deming(validtion_50_range$surface_temp_median ~ validtion_50_range$temp_med)
val_med_dem_50_range

cor(validtion_50_range$surface_temp_median, validtion_50_range$temp_med)

ggplot(validtion_50_range, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_dem_50_range$coefficients[1], slope = val_med_dem_50_range$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_dem_50_range$ci[1,1], slope = val_med_dem_50_range$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_dem_50_range$ci[1,2], slope = val_med_dem_50_range$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'deming_reg_median_50perc_range_v27Sept2021.jpg'), height = 5, width = 5, units = 'in')


```


## predicted v observed 50% cutoff for lake - IQR
```{r}
validtion_50_IQR <- C2_validation_IQR %>% 
  filter(perc_lake > 50)
val_med_ls_50_IQR <- lm(validtion_50_IQR$surface_temp_median ~ validtion_50_IQR$temp_med)
summary(val_med_ls_50_IQR)

val_med_dem_50_IQR <-deming::deming(validtion_50_IQR$surface_temp_median ~ validtion_50_IQR$temp_med)
val_med_dem_50_IQR

cor(validtion_50_IQR$surface_temp_median, validtion_50_IQR$temp_med)

ggplot(validtion_50_IQR, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_dem_50_IQR$coefficients[1], slope = val_med_dem_50_IQR$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_dem_50_IQR$ci[1,1], slope = val_med_dem_50_IQR$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_dem_50_IQR$ci[1,2], slope = val_med_dem_50_IQR$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'deming_reg_median_50perc_IQR_v27Sept2021.jpg'), height = 5, width = 5, units = 'in')


```


## by cloud cover 50% - range

```{r}
validtion_50cc_range <- C2_validation_range %>% 
  filter(cloud_cover < 50)
val_med_ls_50cc_range <- lm(validtion_50cc_range$surface_temp_median ~ validtion_50cc_range$temp_med)
summary(val_med_ls_50cc_range)

val_med_dem_50cc_range <-deming::deming(validtion_50cc_range$surface_temp_median ~ validtion_50cc_range$temp_med)
val_med_dem_50cc_range

cor(validtion_50cc_range$surface_temp_median, validtion_50cc_range$temp_med)

ggplot(validtion_50cc_range, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_dem_50cc_range$coefficients[1], slope = val_med_dem_50cc_range$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_dem_50cc_range$ci[1,1], slope = val_med_dem_50cc_range$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_dem_50cc_range$ci[1,2], slope = val_med_dem_50cc_range$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'deming_reg_median_50perccc_range_v27Sept2021.jpg'), height = 5, width = 5, units = 'in')

```

## by cloud cover 50% - IQR

```{r}
validtion_50cc_IQR <- C2_validation_IQR %>% 
  filter(cloud_cover < 50)
val_med_ls_50cc_IQR <- lm(validtion_50cc_IQR$surface_temp_median ~ validtion_50cc_IQR$temp_med)
summary(val_med_ls_50cc_IQR)

val_med_dem_50cc_IQR <-deming::deming(validtion_50cc_IQR$surface_temp_median ~ validtion_50cc_IQR$temp_med)
val_med_dem_50cc_IQR

cor(validtion_50cc_IQR$surface_temp_median, validtion_50cc_IQR$temp_med)

ggplot(validtion_50cc_IQR, aes(x = temp_med, y = surface_temp_median)) +
  geom_point() +
  geom_abline(intercept = val_med_dem_50cc_IQR$coefficients[1], slope = val_med_dem_50cc_IQR$coefficients[2], color = 'blue') +
  geom_abline(intercept = val_med_dem_50cc_IQR$ci[1,1], slope = val_med_dem_50cc_IQR$ci[2,1], color = 'blue', linetype = 2) +
  geom_abline(intercept = val_med_dem_50cc_IQR$ci[1,2], slope = val_med_dem_50cc_IQR$ci[2,2], color = 'blue', linetype = 2) +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(xlim = c(7,27),
                  ylim = c(7,27)) +
  labs(y = 'satellite-derived median\nskin temperature (deg C)', 
       x = expression(paste(italic('in-situ'), ' median water temp (deg C)'))) +
  final_theme
ggsave(paste0(figdir, 'deming_reg_median_50perccc_IQR_v27Sept2021.jpg'), height = 5, width = 5, units = 'in')

```








#### correlation between doy / pixel count / cloud cover

Because there seems to be some functional dependency between these three, let's show the correlation of the 3 of them
```{r}
cor_pixel_doy = round(cor(x = C2_validation_range$pixel_count, y = C2_validation_range$doy), digits = 2)
pixel_doy <- ggplot(C2_validation_range, aes(x = pixel_count, y = doy)) +
  geom_point() +
  annotate('text', label = paste0('r = ', cor_pixel_doy), y = 125, x = 8500) +
  labs(x = 'pixel count\ncontributing to mean C2_lst', y='day of year') +
  final_theme+
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))

cor_pixel_cloud = round(cor(x = C2_validation_range$pixel_count, y = C2_validation_range$cloud_cover), digits = 2)
pixel_cloud <- ggplot(C2_validation_range, aes(x = pixel_count, y = cloud_cover)) +
  geom_point() +
  annotate('text', label = paste0('r = ', cor_pixel_cloud), y = 0, x = 8500) +
  labs(x = 'pixel count\ncontributing to mean C2_lst', y='percent cloud cover\nin Landsat image') +
  final_theme+
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))

cor_doy_cloud = round(cor(x = C2_validation_range$doy, y = C2_validation_range$cloud_cover), digits = 2)
doy_cloud <- ggplot(C2_validation_range, aes(x = doy, y = cloud_cover)) +
  geom_point() +
  annotate('text', label = paste0('r = ', cor_doy_cloud), y = 0, x = 275) +
  labs(x = 'day of year\n', y='percent cloud cover\nin Landsat image') +
  final_theme+
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))

plot_grid(pixel_doy, pixel_cloud, doy_cloud, labels = c('a', 'b', 'c'), nrow = 1)

ggsave(paste0(dir, 'figures/correlation_plot.png'), width = 12, height = 4)

```



