---
title: "insitu - data download, filter, and collate"
author: "B. Steele"
date: "03/24/2022"
output: html_document
---

R version: 4.0.5 RStudio Version: 1.4.1103

updated 26Mar2019 to include 2018 buoy thermistor data (no upper do data in 2018) 
updated 05July2019 to include 17-18 winter data, 18-19 winter data, oct 18-may 19 data
updated 26March2021 to pull from EDI and to filter for upper value at all locations 
updated 20April2021 to pull LSPA LMP from GitHub
updated 17May2021 to remove monthly sampling (LSPA LMP)
updated 24March2022 with updated LSPA buoy data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source('R_library.R')

dir.create('~/GitHub/ids-ne-lakes/data/temporary')
temp_dumpdir = '~/GitHub/ids-ne-lakes/data/temporary'

dumpdir = '~/GitHub/ids-ne-lakes/data/'
figdir = '~/GitHub/ids-ne-lakes/figures/'
```

## Read in files from EDI and filter for desired data

These code chunks in this section are copied directly from the EDI website except the LSPA LMP data.

### Winter Hobo files at the buoy site

```{r}
# Package ID: edi.500.2 Cataloging System:https://pasta.edirepository.org.
# Data set title: High-frequency under-ice water temperature and dissolved oxygen at Lake Sunapee, New Hampshire, USA, 2014-2019.
# Data set creator:   LSPA - Lake Sunapee Protective Association 
# Data set creator:  Kathleen Weathers - Cary Institute of Ecosystem Studies 
# Data set creator:  Bethel Steele - Cary Institute of Ecosystem Studies 
# Contact:   LSPA -  Lake Sunapee Protective Association  - lspa@lakesunapee.org
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu 

inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/500/2/a64a1a7af863d8310daa9b8859060bc7" 
infile1 <- tempfile(tmpdir = temp_dumpdir)
try(download.file(inUrl1,infile1,method = 'curl'))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")


winterhobo <-read.csv(infile1
                      ,header=F 
               ,skip=1
               ,sep=","  
               , col.names=c(
                 "datetime",     
                 "do_ppm",     
                 "TempC_1p5m",     
                 "TempC_2p5m",     
                 "TempC_3p5m",     
                 "TempC_4p5m",     
                 "TempC_5p5m",     
                 "TempC_6p5m",     
                 "TempC_7p5m",     
                 "TempC_8p5m",     
                 "TempC_9p5m",     
                 "TempC_10p5m",     
                 "location"    ), check.names=TRUE)

unlink(infile1)


inUrl2  <- "https://pasta.lternet.edu/package/data/eml/edi/500/2/9cd342fb70af70d79bc3a258aedeed26" 
infile2 <- tempfile(tmpdir = temp_dumpdir)
try(download.file(inUrl2,infile2,method="curl"))
if (is.na(file.size(infile2))) download.file(inUrl2,infile2,method="auto")

winterhobo_loc <-read.csv(infile2,header=F 
               ,skip=1
               ,sep=","  
               , col.names=c(
                 "location",     
                 "lat_dd",     
                 "long_dd"    ), check.names=TRUE)

unlink(infile2)


```

### Sunapee Buoy data

```{r}
# Package ID: edi.499.3 Cataloging System:https://pasta.edirepository.org.
# Data set title: Lake Sunapee Instrumented Buoy: High Frequency Water Temperature and Dissolved Oxygen Data - 2007-2021
# Data set creator:   LSPA - Lake Sunapee Protective Association 
# Data set creator:  Bethel Steele - Cary Institute of Ecosystem Studies 
# Data set creator:  Kathleen Weathers - Cary Institute of Ecosystem Studies 
# Contact:   Bethel Steele steeleb@caryinstitute.org
buoy2007do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=d7678325ec3a430959b52c8a933c810a') 
buoy2007<- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=8aa419258c486d5533fc016c7385afdd')
buoy2008do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=212faee8c415ed9dd76941e1377b20e6')
buoy2008 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=107e661231ad954a2f9ce746ed934971')
buoy2009do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=0e6f5952d384e6a2543105cb76d125fe')
buoy2009 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=d9c1a224897c64fb505cc4ad9ff7d08d')
buoy2010do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=cfb900f44c5d36309b0b56e02711e293')
buoy2010 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=64780f1f23d94cbe2e05f9d1e2e255d1') 
buoy2011do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=60d5e40e996fc2108e24be4ad6d69c7e') 
buoy2011 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=26fed3d0522dab567be961851f21dcb9') 
buoy2012do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=b7d876e7473633966294314914fe388a') 
buoy2012 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=ea5fcc3b97f9f749f88209ca0303fb2d') 
buoy2013do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=7f95b231683aeeadc78833d8c4d66306')
buoy2013 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=a34bcb5569a2423ab612c87548f9a4a4')
buoy2014do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=4ac2414fd93a86def62805146ac2ed4e')
buoy2014 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=171b3fd9023d04a19da1ae15e315f5cc')
buoy2015do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=74e012a632de8e0db298bb2b4018297e') 
buoy2015hobo <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=1b29196704e1cc767317aeb5197eec15')
buoy2015 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=1d57e128cd609b79270521707cc7d54d') 
buoy2016do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=fcaad5eb5d0b16aeb1c93ebd7831a0a5')
buoy2016 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=4d6fd420e205197d5fca25cb53258bd7')
buoy2017do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=9e96ecffa80956309c38368a6f5fbf12')
buoy2017 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=e92780d73355a9aecb4c98ff02ee3d3f') 
buoy2018do <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=8fe7c6d1335a4010b05fe5c6fcb3066c') 
buoy2018hobo<- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=189b9375726f0f48b7ffc54f464b6b21') 
buoy2018  <-  read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=d6c8f8251e4f5873da2a3f69ad2d2d62') 
buoy2019do <-  read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=023fa990bf6fc6714268913a2c06ba39') 
buoy2019 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=66da82b133c13591015006149d0a4576') 
buoy2020do  <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=e8af5fb9f62c635a64470146cbe714c1') 
buoy2020 <-  read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=3ef7eaaea1fe6cb9ccbb9b7de173e790') 
buoy2021do<- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=59a07057a549ddcd3a2a4dc00f89f136') 
buoy2021exo <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=640fd64c7e6d67495ef4c72f771e6907') 
buoy2021 <- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=e69f75756b69ae1b7a6d20f7c4370671') 
buoylocation<- read.csv('https://portal.edirepository.org/nis//dataviewer?packageid=edi.499.3&entityid=8ce0dbc0ba51cc2f3e8f9fd891486d57') 

```

### gloeo trap sensors

```{r}
# Package ID: edi.498.1 Cataloging System:https://pasta.edirepository.org.
# Data set title: High-frequency temperature data from four near-shore sites, Lake Sunapee, NH, USA, 2006-2018.
# Data set creator:  Kathryn Cottingham - Dartmouth College 
# Data set creator:  Cayelan Carey - Virginia Tech 
# Data set creator:  Kathleen Weathers - Cary Institute of Ecosystem Studies 
# Contact:  Kathryn Cottingham -  Dartmouth College  - kathryn.l.cottingham@dartmouth.edu
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu 

inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/498/1/f707d161d96899983f0f82845849427e" 
infile1 <- tempfile(tmpdir = temp_dumpdir)
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")

                   
 gloeo_depths <-read.csv(infile1,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "year",     
                    "site",     
                    "approx_depth_m"    ), check.names=TRUE)
               
unlink(infile1)
		    


inUrl2  <- "https://pasta.lternet.edu/package/data/eml/edi/498/1/074c7dcfa74cdafbc71ccee9c4b97293" 
infile2 <- tempfile(tmpdir = temp_dumpdir)
try(download.file(inUrl2,infile2,method="curl"))
if (is.na(file.size(infile2))) download.file(inUrl2,infile2,method="auto")

                   
 gloeo_locs <-read.csv(infile2,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "site",     
                    "lat_dd",     
                    "long_dd"    ), check.names=TRUE)
               
unlink(infile2)


inUrl3  <- "https://pasta.lternet.edu/package/data/eml/edi/498/1/b4f60789ceb87db613924ca43a2f71ed" 
infile3 <- tempfile(tmpdir = temp_dumpdir)
try(download.file(inUrl3,infile3,method="curl"))
if (is.na(file.size(infile3))) download.file(inUrl3,infile3,method="auto")

                   
 gloeo_temp <-read.csv(infile3,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "year",     
                    "dayofyr",     
                    "time",     
                    "datetime",     
                    "site",     
                    "temp_degC"    ), check.names=TRUE)
               
unlink(infile3)

```

### 2018 mini buoys

```{r}
# Package ID: edi.395.2 Cataloging System:https://pasta.edirepository.org.
# Data set title: Underwater temperature, light, and dissolved oxygen data from 3 mini-buoys in Lake Sunapee, NH, USA from June to October 2018.
# Data set creator:  Nicole Ward - Virginia Tech 
# Data set creator:  Jennifer Brentrup - Dartmouth College 
# Data set creator:  Ava Johnson - Virginia Tech 
# Data set creator:  Cayelan Carey - Virginia Tech 
# Data set creator:  Kathleen Weathers - Cary Institute of Ecosystem Studies 
# Data set creator:  June Fichter - Lake Sunapee Protective Association 
# Contact:  Nicole Ward -  Virginia Tech  - nkward@vt.edu
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu 

inUrl2  <- "https://pasta.lternet.edu/package/data/eml/edi/395/2/551bad10969f758453be2d3e1f540fac" 
infile2 <- tempfile()
try(download.file(inUrl2,infile2,method="curl"))
if (is.na(file.size(infile2))) download.file(inUrl2,infile2,method="auto")

                   
 GM_temp <-read.csv(infile2,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "dateTime",     
                    "temp",     
                    "Depth",     
                    "SerialNum"    ), check.names=TRUE)
               
unlink(infile2)
		    

inUrl6  <- "https://pasta.lternet.edu/package/data/eml/edi/395/2/fa1a9ddd31509aa2c5a559e20b75e015" 
infile6 <- tempfile()
try(download.file(inUrl6,infile6,method="curl"))
if (is.na(file.size(infile6))) download.file(inUrl6,infile6,method="auto")

                   
 HC_temp <-read.csv(infile6,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "dateTime",     
                    "temp",     
                    "Depth",     
                    "SerialNum"    ), check.names=TRUE)
               
unlink(infile6)

inUrl8  <- "https://pasta.lternet.edu/package/data/eml/edi/395/2/f07dc3a8ecb04f61747a82e7a1da5846" 
infile8 <- tempfile()
try(download.file(inUrl8,infile8,method="curl"))
if (is.na(file.size(infile8))) download.file(inUrl8,infile8,method="auto")

                   
 SB_temp <-read.csv(infile8,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "dateTime",     
                    "temp",     
                    "Depth",     
                    "SerialNum"    ), check.names=TRUE)
               
unlink(infile8)
		    
 
        
```


## Harmonize, Filter, Collate data

### winter hobo data

```{r}
winterhobo_filter <- winterhobo %>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) %>% 
  select(datetime, location, TempC_1p5m) %>% 
  rename(temp_degC = TempC_1p5m) %>% 
  mutate(depth_m = 1.5,
         source = 'edi.500.2') %>% 
  left_join(., winterhobo_loc) %>% 
  filter(!is.na(temp_degC))

```

### buoy data

```{r}
buoytemp <- full_join(buoy2007, buoy2007do) %>% 
        full_join(., buoy2008)  %>% 
        full_join(., buoy2008do)  %>% 
        full_join(., buoy2009)  %>% 
        full_join(., buoy2009do)  %>% 
        full_join(., buoy2010)  %>% 
        full_join(., buoy2010do)  %>% 
        full_join(., buoy2011)  %>% 
        full_join(., buoy2011do)  %>% 
        full_join(., buoy2012)  %>% 
        full_join(., buoy2012do)  %>% 
        full_join(., buoy2013)  %>% 
        full_join(., buoy2013do)  %>% 
        full_join(., buoy2014)  %>% 
        full_join(., buoy2014do)  %>% 
        full_join(., buoy2015)  %>% 
        full_join(., buoy2015do)  %>% 
        full_join(., buoy2015hobo) %>% 
        full_join(., buoy2016)  %>% 
        full_join(., buoy2016do)  %>% 
        full_join(., buoy2017)  %>% 
        full_join(., buoy2017do)  %>% 
        full_join(., buoy2018)  %>% 
        full_join(., buoy2018do)  %>% 
        full_join(., buoy2018hobo) %>% 
        full_join(., buoy2019)  %>% 
        full_join(., buoy2019do)  %>% 
        full_join(., buoy2020)  %>% 
        full_join(., buoy2020do)  %>% 
        full_join(., buoy2021)  %>% 
        full_join(., buoy2021do) %>% 
        full_join(., buoy2021exo)

#select only temp <= 1.5m
buoytemp_filter <- buoytemp %>% 
        select(datetime, location, 
               waterTemperature_degC_0p1m, waterTemperature_degC_0p25m, 
               waterTemperature_degC_0p5m, waterTemperature_degC_0p75m,
                waterTemperature_degC_0p85m, waterTemperature_degC_1m, 
               waterTemperature_degC_1p5m, 
               flag_alltemp, flag_temp0p5m, flag_temp0p75m, flag_temp0p85m)


# look at flags
#flag definitions:
# n noise in data stream
# s	suspect readings
# i	intermittent readings
# d	depth likely incorrect/sensor hung up
# a	sensor reporting on 20min intervals *this is irrelevant to this purpose
# b	sensor may be in sediment *11m and 13m already removed, can ignore

unique(buoytemp_filter$flag_alltemp)
# remove suspect/x data
buoytemp_filter <- buoytemp_filter %>% 
        filter(!grepl('s; x', flag_alltemp)) %>% 
        select(-flag_alltemp)
unique(buoytemp_filter$flag_temp0p5m) #i is okay
unique(buoytemp_filter$flag_temp0p75m)
unique(buoytemp_filter$flag_temp0p85m)
#drop flags
buoytemp_filter <- buoytemp_filter %>% 
        select(-flag_temp0p5m, -flag_temp0p75m, -flag_temp0p85m)
        
#filter buoy temp string
buoytemp_filter <- buoytemp_filter %>% 
  select(datetime, waterTemperature_degC_0p1m:waterTemperature_degC_1p5m, location) %>% #only select 1.5 or closer to surface
  pivot_longer(cols = c(waterTemperature_degC_0p1m:waterTemperature_degC_1p5m)) %>% 
  mutate(depth_m = case_when(grepl('0p1m', name) ~ 0.1,
                             grepl('0p25m', name) ~ 0.25,
                             grepl('0p5m', name) ~ 0.5,
                           grepl('0p75m', name) ~ 0.75,
                           grepl('0p85m', name) ~ 0.85,
                           grepl('1m', name) ~ 1.0,
                           grepl('1p5m', name) ~ 1.5,
                           TRUE ~ NA_real_)) %>% 
        filter(!is.na(value))

buoytemp_filter <- buoytemp_filter %>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) %>% 
  rename(temp_degC = value) %>% 
  select(-name)
  
#filter do string
buoydo_filter <- buoydo %>% 
        
        
  select(datetime, DOTempC, upper_do_flag, location) %>% 
  rename(temp_degC = DOTempC) %>% 
  mutate(depth_m = 1.5) %>% 
  filter(!is.na(temp_degC))
  
unique(buoydo_filter$upper_do_flag)
#flag definition
# d	depth likely incorrect/sensor hung up
# w	sensor cleaned, not calibrated
# c	sensor calibrated
# m	 miscalibrated - not to be used without correction
# p	cleaning/calibration not documented - presumed from data
# i	intermittent readings
# x	do sensor likely uncalibrated, no documentation of calibration

#only flag that might impact temp from this sensor is 'i'
buoydo_filter <- buoydo_filter %>% 
  mutate(temp_degC = case_when(grepl('i', upper_do_flag) ~ NA_real_,
                               TRUE ~ temp_degC)) %>% 
  filter(!is.na(temp_degC)) %>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) %>% 
  select(-upper_do_flag)

#filter hobo temp string
buoyhobo_filter <- buoyhobo %>% 
  select(datetime, TempC_0p5m, TempC_1p5m, location) %>% 
  pivot_longer(cols = c(TempC_0p5m, TempC_1p5m), values_to = 'temp_degC') %>% 
  mutate(depth_m = case_when(grepl('0p5m', name) ~ 0.5,
                           grepl('1p5m', name) ~ 1.5,
                           TRUE ~ NA_real_)) %>% 
  filter(!is.na(temp_degC))%>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) %>% 
  select(-name)

#filter hobo do string
buoyhobodo_filter <- buoyhobodo %>% 
  select(datetime, location, temp_degC, hobodo_flag) %>% 
  mutate(depth_m = 0.25) %>% 
  filter(!is.na(temp_degC))

unique(buoyhobodo_filter$hobodo_flag)
# no applicable flags
buoyhobodo_filter <- buoyhobodo_filter %>% 
  select(-hobodo_flag)%>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) 

#join buoy data together
buoy_filter <- full_join(buoydo_filter, buoyhobo_filter) %>% 
  full_join(., buoyhobodo_filter) %>% 
  full_join(., buoytemp_filter) %>% 
  mutate(source = 'edi.499.2')

#add location information
buoy_filter <- buoy_filter %>% 
  left_join(., buoy_loc)

#filter for topmost temp reading per timestamp
buoy_filter <- buoy_filter %>% 
  mutate(datetime = as.POSIXct(datetime, tz='UTC')) %>% 
  arrange(datetime, depth_m) %>% 
  group_by(datetime, location, source, lat_dd, long_dd) %>% 
  summarize(temp_degC = first(temp_degC),
            depth_m = first(depth_m)) %>% 
  ungroup()
```

### gloeo trap sensors

DST is observed in this dataset. See if any measurements taken over period of DST
```{r}
#look for datetimes outside of dst
gloeo_temp %>% 
  group_by(year) %>% 
  arrange(datetime) %>% 
  summarise(firstdatetime = first(datetime),
            lastdatetime = last(datetime))

```

There is no overlap with DST, just need to adjust time to no DST observed for integration with all other datasets

```{r}

gloeo_temp_dstadj <- gloeo_temp %>% 
  mutate(datetime = as.POSIXct(datetime, tz = 'UTC')) %>% 
  mutate(datetime_adj = datetime - lubridate::hours(1))

```

Now filter with new datetime as datetime no dst observed

```{r}
#remove unnecessary columns, rename adjusted time
gloeo_temp_dstadj <- gloeo_temp_dstadj %>% 
  select(-dayofyr, -time, -datetime) %>% 
  rename(datetime = datetime_adj)

#join with depth data
gloeo_temp_dstadj <- full_join(gloeo_temp_dstadj, gloeo_depths)

#where depth is na, fill in with 1.5 so data is included prior to 2011
gloeo_temp_dstadj <- gloeo_temp_dstadj %>% 
  mutate(depth_m = case_when(is.na(approx_depth_m) ~ 1.5,
                             TRUE ~ approx_depth_m)) %>% 
  select(-year, -approx_depth_m)

#join with loc data
gloeo_temp_dstadj <- full_join(gloeo_temp_dstadj, gloeo_locs) %>% 
        filter(depth_m <= 1.5)

#add source info, rename site to location
gloeo_temp_dstadj <- gloeo_temp_dstadj %>% 
  mutate(source = 'edi.498.1') %>% 
  rename(location = site)

gloeo_temp_dstadj
```

### mini buoy data

```{r}
#add location info
GM_temp <- GM_temp %>% 
  mutate(location = 'GeorgesMills',
         lat_dd = 43.4288,
         long_dd = -72.0675)

HC_temp <- HC_temp %>% 
  mutate(location = 'HerrickCove',
         lat_dd = 43.4096,
         long_dd = -72.033)

SB_temp <- SB_temp %>% 
  mutate(location = 'StateBeach',
         lat_dd = 43.3436,
         long_dd = -72.0595)

#join and filter for topmost sensor
minibuoy_temp_filter <- full_join(GM_temp, HC_temp) %>% 
  full_join(SB_temp) %>% 
  rename(datetime = dateTime, 
         depth_m = Depth) %>% 
  filter(!is.na(temp)) %>% 
  arrange(datetime, depth_m) %>% 
  group_by(datetime, location, lat_dd, long_dd) %>% 
  summarize(temp_degC = first(temp),
            depth_m = first(depth_m)) %>% 
  ungroup()

#add source info
minibuoy_temp_filter <- minibuoy_temp_filter %>% 
  mutate(source = 'edi.395.2')

# round to 2 digits after decimal
minibuoy_temp_filter <- minibuoy_temp_filter %>% 
  mutate(temp_degC = round(temp_degC, digits = 2))

minibuoy_temp_filter
  
```


## Join all data together

```{r}
#join all and mark frequency
all_temp <- full_join(winterhobo_filter, buoy_filter) %>% 
  full_join(gloeo_temp_dstadj) %>% 
  full_join(minibuoy_temp_filter)

#filter for may through nov (ice out season)
all_temp_filtered <- all_temp %>% 
  mutate(month = as.numeric(format(datetime, '%m'))) %>% 
  filter(month >= 5 & month <= 11)

#reorg columns
all_temp_filtered <- all_temp_filtered %>% 
  select(datetime, lat_dd, long_dd, location, depth_m, temp_degC, source, month)
```

## export data

```{r}
all_temp_filtered %>% 
  mutate(datetime = as.character(datetime)) %>% 
  write_csv(., paste0(figdir, 'STB_insitu_temp_data_v', Sys.Date(), '.csv'))
```


